(window.webpackJsonp=window.webpackJsonp||[]).push([[36],{308:function(t,s,e){"use strict";e.r(s);var a=e(14),r=Object(a.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("p",[t._v("[TOC]")]),t._v(" "),s("p",[t._v("在日常使用文件服务器时，由于可能宕机等原因，需要有一个实时备份的服务器实现高可用本文使用rsync + inotify-tools实现文件在不同服务器\n的自动备份。")]),t._v(" "),s("p",[t._v("参考文档：\nhttps://blog.51cto.com/ljohn/2047156")]),t._v(" "),s("p",[t._v("特别感谢！！！")]),t._v(" "),s("h2",{attrs:{id:"_1-安装所需工具"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-安装所需工具"}},[t._v("#")]),t._v(" 1. 安装所需工具")]),t._v(" "),s("h4",{attrs:{id:"_1-1-rsync-安装"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-1-rsync-安装"}},[t._v("#")]),t._v(" 1.1 rsync 安装")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("apt-get install rsync\n")])])]),s("h4",{attrs:{id:"_1-2-xinetd-安装"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-2-xinetd-安装"}},[t._v("#")]),t._v(" 1.2 xinetd 安装")]),t._v(" "),s("p",[t._v("即extended internet daemon，是新一代的网络守护进程服务程序，又叫超级Internet服务器，常用来管理多种轻量级Internet服务。Xinetd提供类似于inetd+tcp_wrapper的功能，但是更加强大和安全。")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("apt-get install xinetd\n\n#启动\nservice xinetd start\n#停止\nservice xinetd stop\n#重启\nservice xinetd restart\n")])])]),s("p",[t._v("配置文件是"),s("code",[t._v("/etc/xinetd.conf")]),t._v("，但是它只包括默认值，并包含/etc/xinetd.d目录中的配置文件")]),t._v(" "),s("h4",{attrs:{id:"_1-3-inotify-tools-安装"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-3-inotify-tools-安装"}},[t._v("#")]),t._v(" 1.3 inotify-tools 安装")]),t._v(" "),s("p",[t._v("源码路径")]),t._v(" "),s("p",[t._v("https://github.com/inotify-tools/inotify-tools/wiki")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("apt-get install inotify-tools\n")])])]),s("h2",{attrs:{id:"_2-准备服务器"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-准备服务器"}},[t._v("#")]),t._v(" 2. 准备服务器")]),t._v(" "),s("p",[t._v("准备两台服务器：")]),t._v(" "),s("p",[t._v("备份服务器：192.168.1.103")]),t._v(" "),s("p",[t._v("主服务器：192.168.1.107")]),t._v(" "),s("p",[t._v("即实时自动同步主服务器文件到备份服务器")]),t._v(" "),s("h2",{attrs:{id:"_3-备份服务器配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-备份服务器配置"}},[t._v("#")]),t._v(" 3. 备份服务器配置")]),t._v(" "),s("h4",{attrs:{id:"_3-1-xinetd的启动rsync配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-xinetd的启动rsync配置"}},[t._v("#")]),t._v(" 3.1 xinetd的启动rsync配置")]),t._v(" "),s("p",[t._v("新建配置文件")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("# vim /etc/xinetd.d/rsync\nservice rsync\n{\n        disable = no            #修改为no\n        flags           = IPv6\n        socket_type     = stream\n        wait            = no\n        user            = root\n        server          = /usr/bin/rsync\n        server_args     = --daemon\n        log_on_failure  += USERID\n}\n")])])]),s("p",[t._v("启动xinetd")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("/etc/init.d/xinetd start \n")])])]),s("h4",{attrs:{id:"_3-2-创建rsync配置文件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-创建rsync配置文件"}},[t._v("#")]),t._v(" 3.2 创建rsync配置文件")]),t._v(" "),s("p",[t._v("新建rsync配置文件")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("vim /etc/rsyncd.conf\n")])])]),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("log file = /var/log/rsyncd.log\npid file = /var/run/rsyncd.pid\nlock file = /var/run/rsync.lock\nsecrets file = /etc/rsync.pass\nmotd file = /etc/rsyncd.Motd\nuid = root\ngid = root\nport =873\nuse chroot = no\nread only = no\nlist = no\ntimeout = 600\nauth users = root\nhosts allow = 192.168.1.0/24\n[app_rsync_client]\npath = /app/rsync_client\ncomment = app_rsync_client\n")])])]),s("p",[t._v("参数说明：")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("rsyncd.conf参数")]),t._v(" "),s("th",[t._v("参数说明")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("uid=rsync")]),t._v(" "),s("td",[t._v("rsync使用的用户。")])]),t._v(" "),s("tr",[s("td",[t._v("gid=rsync")]),t._v(" "),s("td",[t._v("rsync使用的用户组（用户所在的组）")])]),t._v(" "),s("tr",[s("td",[t._v("use chroot=no")]),t._v(" "),s("td",[t._v("如果为true，daemon会在客户端传输文件前“chroot to the path”。这是一种安全配置，因为我们大多数都在内网，所以不配也没关系")])]),t._v(" "),s("tr",[s("td",[t._v("max connections=200")]),t._v(" "),s("td",[t._v("设置最大连接数，默认0，意思无限制，负值为关闭这个模块")])]),t._v(" "),s("tr",[s("td",[t._v("timeout=400")]),t._v(" "),s("td",[t._v("默认为0，表示no timeout，建议300-600（5-10分钟）")])]),t._v(" "),s("tr",[s("td",[t._v("pid file")]),t._v(" "),s("td",[t._v("rsync daemon启动后将其进程pid写入此文件。如果这个文件存在，rsync不会覆盖该文件，而是会终止")])]),t._v(" "),s("tr",[s("td",[t._v("lock file")]),t._v(" "),s("td",[t._v("指定lock文件用来支持“max connections”参数，使得总连接数不会超过限制")])]),t._v(" "),s("tr",[s("td",[t._v("log file")]),t._v(" "),s("td",[t._v("不设或者设置错误，rsync会使用rsyslog输出相关日志信息")])]),t._v(" "),s("tr",[s("td",[t._v("ignore errors")]),t._v(" "),s("td",[t._v("忽略I/O错误")])]),t._v(" "),s("tr",[s("td",[t._v("read only=false")]),t._v(" "),s("td",[t._v("指定客户端是否可以上传文件，默认对所有模块为true")])]),t._v(" "),s("tr",[s("td",[t._v("list=false")]),t._v(" "),s("td",[t._v("是否允许客户端可以查看可用模块列表，默认为可以")])]),t._v(" "),s("tr",[s("td",[t._v("hosts allow")]),t._v(" "),s("td",[t._v("指定可以联系的客户端主机名或和ip地址或地址段，默认情况没有此参数，即都可以连接")])]),t._v(" "),s("tr",[s("td",[t._v("hosts deny")]),t._v(" "),s("td",[t._v("指定不可以联系的客户端主机名或ip地址或地址段，默认情况没有此参数，即都可以连接")])]),t._v(" "),s("tr",[s("td",[t._v("auth users")]),t._v(" "),s("td",[t._v("指定以空格或逗号分隔的用户可以使用哪些模块，用户不需要在本地系统中存在。默认为所有用户无密码访问")])]),t._v(" "),s("tr",[s("td",[t._v("secrets file")]),t._v(" "),s("td",[t._v("指定用户名和密码存放的文件，格式；用户名；密码，密码不超过8位")])]),t._v(" "),s("tr",[s("td",[t._v("[backup]")]),t._v(" "),s("td",[t._v("这里就是模块名称，需用中括号扩起来，起名称没有特殊要求，但最好是有意义的名称，便于以后维护")])]),t._v(" "),s("tr",[s("td",[t._v("path")]),t._v(" "),s("td",[t._v("这个模块中，daemon使用的文件系统或目录，目录的权限要注意和配置文件中的权限一致，否则会遇到读写的问题")])])])]),t._v(" "),s("p",[t._v("新建密码文件")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("vim /etc/rsync.pass\n")])])]),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("root:12345678\n")])])]),s("blockquote",[s("p",[t._v("格式 用户名:密码    可以设置多个，每行一个用户名:密码")])]),t._v(" "),s("h4",{attrs:{id:"_3-3-赋权重启"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-3-赋权重启"}},[t._v("#")]),t._v(" 3.3 赋权重启")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("chmod 600 /etc/rsyncd.conf \nchmod 600 /etc/rsync.pass \nservice xinetd restart\n")])])]),s("h2",{attrs:{id:"_4-主服务器配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-主服务器配置"}},[t._v("#")]),t._v(" 4. 主服务器配置")]),t._v(" "),s("h4",{attrs:{id:"_4-1-xinetd的启动rsync配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-xinetd的启动rsync配置"}},[t._v("#")]),t._v(" 4.1 xinetd的启动rsync配置")]),t._v(" "),s("p",[t._v("新建配置文件")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("# vim /etc/xinetd.d/rsync\nservice rsync\n{\n        disable = no            #修改为no\n        flags           = IPv6\n        socket_type     = stream\n        wait            = no\n        user            = root\n        server          = /usr/bin/rsync\n        server_args     = --daemon\n        log_on_failure  += USERID\n}\n")])])]),s("p",[t._v("启动xinetd")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("/etc/init.d/xinetd start \n")])])]),s("h4",{attrs:{id:"_4-2-新建密码文件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-新建密码文件"}},[t._v("#")]),t._v(" 4.2 新建密码文件")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("# vim /etc/passwd.txt\n123456\n\n# chmod 600 /etc/passwd.txt\n")])])]),s("blockquote",[s("p",[t._v("主服务密码不需要配置文件和备份服务器rsync需要的同步文件格式不一样，需要特别注意！")])]),t._v(" "),s("h4",{attrs:{id:"_4-3-测试"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-测试"}},[t._v("#")]),t._v(" 4.3 测试")]),t._v(" "),s("p",[t._v("在"),s("code",[t._v("/app/rsync_server/")]),t._v("目录下新建一文件")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("mkdir -pv /app/rsync_server && touch /app/rsync_server/test.txt\n")])])]),s("p",[t._v("执行同步命令")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("rsync -avH --port=873 --progress --delete /app/rsync_server/ root@192.168.1.103::app_rsync_client --password-file=/etc/passwd.txt\n")])])]),s("blockquote",[s("p",[t._v("在主服务器rsync文件到备份服务器的时候，如果失败，日志在备份服务器/var/log/rsyncd.log，可查看相关日志进行问题定位")])]),t._v(" "),s("h2",{attrs:{id:"_5-使用inotify-tools实现自动同步"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-使用inotify-tools实现自动同步"}},[t._v("#")]),t._v(" 5. 使用inotify-tools实现自动同步")]),t._v(" "),s("h4",{attrs:{id:"_5-1-主服务器配置inotify-tools"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-主服务器配置inotify-tools"}},[t._v("#")]),t._v(" 5.1 主服务器配置inotify-tools")]),t._v(" "),s("p",[t._v("在 "),s("code",[t._v("/etc/sysctl.conf")]),t._v("后添加")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("fs.inotify.max_queued_events = 99999999\nfs.inotify.max_user_watches = 99999999\nfs.inotify.max_user_instances = 65535\n")])])]),s("p",[t._v("且立即生效")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("sysctl  -p\n")])])]),s("blockquote",[s("p",[t._v('max_queued_events：inotify队列最大长度，如果值太小，会出现"** Event Queue Overflow **"错误，导致监控文件不准确')])]),t._v(" "),s("blockquote",[s("p",[t._v("max_user_watches：要同步的文件包含多少目录，可以用：find /app/rsync_server/ -type d | wc -l 统计，必须保证max_user_watches值大于统计结果（这里/app/rsync_server/为同步文件目录）")])]),t._v(" "),s("blockquote",[s("p",[t._v("max_user_instances：每个用户创建inotify实例最大值")])]),t._v(" "),s("h4",{attrs:{id:"_5-2-新建实时同步脚本"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-新建实时同步脚本"}},[t._v("#")]),t._v(" 5.2 新建实时同步脚本")]),t._v(" "),s("p",[t._v("/usr/local/inotify/rsync.sh")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v('#!/bin/bash\nsrc_dir="/app/rsync_server/"\ndst_dir="app_rsync_client"\nexclude_dir="/usr/local/inotify/exclude.list"\nrsync_user="root"\nrsync_passwd="/etc/passwd.txt"\ndst_ip="192.168.1.103"\nrsync_command(){\necho rsync -avH --port=873 --progress --delete --exclude-from=$exclude_dir $src_dir $rsync_user@$ip::$dst_dir --password-file=$rsync_passwd\nrsync -avH --port=873 --progress --delete --exclude-from=$exclude_dir $src_dir $rsync_user@$ip::$dst_dir --password-file=$rsync_passwd\n}\nfor ip in $dst_ip;do\n     rsync_command\ndone\n    /usr/bin/inotifywait -mrq --timefmt \'%d/%m/%y %H:%M\' --format \'%T %w%f%e\' -e close_write,modify,delete,create,attrib,move $src_dir \\\n| while read file;do\n   for ip in $dst_ip;do\n       rsync_command\n       echo "${file} was rsynced" >> /tmp/rsync.log 2>&1\n   done\n done\n')])])]),s("p",[t._v("执行相关脚本即可")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("chmod +x /usr/local/inotify/rsync.sh\ntouch /usr/local/inotify/exclude.list\nbash /usr/local/inotify/rsync.sh\n")])])])])}),[],!1,null,null,null);s.default=r.exports}}]);